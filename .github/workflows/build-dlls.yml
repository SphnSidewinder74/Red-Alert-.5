name: Build DLLs on Windows

on:
  push:
    branches: [ master, replit-agent ]
    paths:
      - 'OpenRA.Mods.RA05/**'
      - 'mod.config'
      - '.github/workflows/build-dlls.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Fetch OpenRA engine
      shell: cmd
      run: |
        call fetch-engine.sh
        
    - name: Build mod DLLs
      shell: cmd
      run: |
        call make.cmd all /p:Configuration=Release
        
    - name: Collect DLLs
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dll-output
        
        # Copy DLLs from actual build output directories
        $platformDll = "engine\OpenRA.Platforms.Default.dll"
        if (!(Test-Path $platformDll) -or (Get-Item $platformDll).Length -eq 0) {
          Write-Error "OpenRA.Platforms.Default.dll not built or is empty!"
          exit 1
        }
        
        Copy-Item -Path $platformDll -Destination "dll-output\" -ErrorAction Stop
        Copy-Item -Path "engine\mods\common\OpenRA.Mods.Common.dll" -Destination "dll-output\" -ErrorAction SilentlyContinue
        Copy-Item -Path "engine\mods\common\OpenRA.Mods.Cnc.dll" -Destination "dll-output\" -ErrorAction SilentlyContinue
        Copy-Item -Path "engine\mods\as\OpenRA.Mods.AS.dll" -Destination "dll-output\" -ErrorAction SilentlyContinue
        Copy-Item -Path "mods\radot5\OpenRA.Mods.RA05.dll" -Destination "dll-output\" -ErrorAction SilentlyContinue
        
        Write-Host "Successfully collected DLLs:"
        Get-ChildItem dll-output | Format-Table Name, Length
        
    - name: Upload DLLs as artifact
      uses: actions/upload-artifact@v4
      with:
        name: compiled-dlls
        path: dll-output/*.dll
        retention-days: 90
        
    - name: Commit DLLs to repository
      shell: pwsh
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        Copy-Item -Path "dll-output\OpenRA.Platforms.Default.dll" -Destination "engine\" -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "dll-output\OpenRA.Mods.Common.dll" -Destination "engine\mods\common\" -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "dll-output\OpenRA.Mods.Cnc.dll" -Destination "engine\mods\common\" -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "dll-output\OpenRA.Mods.AS.dll" -Destination "engine\mods\as\" -Force -ErrorAction SilentlyContinue
        Copy-Item -Path "dll-output\OpenRA.Mods.RA05.dll" -Destination "mods\radot5\" -Force -ErrorAction SilentlyContinue
        
        git add -f engine/OpenRA.Platforms.Default.dll engine/mods/common/OpenRA.Mods.Common.dll engine/mods/common/OpenRA.Mods.Cnc.dll engine/mods/as/OpenRA.Mods.AS.dll mods/radot5/OpenRA.Mods.RA05.dll
        
        # Check if there are changes to commit
        $status = git status --short
        if (-not [string]::IsNullOrWhiteSpace($status)) {
          git commit -m "Auto-build: Update compiled DLLs from Windows build"
          git push
        } else {
          Write-Host "No changes to commit - DLLs are up to date"
        }
